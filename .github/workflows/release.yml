name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PROJECT_NAME: ClaudeCodeApiConfigManager
  CONFIGURATION: Release

jobs:
  # ==================== ç¬¬ä¸€æ­¥ï¼šæ„å»ºï¼ˆä¸²è¡Œï¼‰====================
  build-linux-x64:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: å‘å¸ƒ linux-x64
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r linux-x64 -p:PublishAot=true -o ./publish/ccm-linux-x64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-linux-x64-bin
          path: ./publish/ccm-linux-x64
          retention-days: 7

  build-linux-arm64:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: build-linux-x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: å‘å¸ƒ linux-arm64
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r linux-arm64 -p:PublishAot=true -o ./publish/ccm-linux-arm64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-linux-arm64-bin
          path: ./publish/ccm-linux-arm64
          retention-days: 7

  build-win-x86:
    runs-on: windows-latest
    timeout-minutes: 45
    needs: build-linux-arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: å‘å¸ƒ win-x86
        shell: pwsh
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r win-x86 -p:PublishAot=true -o ./publish/ccm-win-x86
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-win-x86-bin
          path: ./publish/ccm-win-x86
          retention-days: 7

  build-win-x64:
    runs-on: windows-latest
    timeout-minutes: 45
    needs: build-win-x86
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: å‘å¸ƒ win-x64
        shell: pwsh
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r win-x64 -p:PublishAot=true -o ./publish/ccm-win-x64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-win-x64-bin
          path: ./publish/ccm-win-x64
          retention-days: 7

  build-win-arm64:
    runs-on: windows-latest
    timeout-minutes: 45
    needs: build-win-x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: å‘å¸ƒ win-arm64
        shell: pwsh
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r win-arm64 -p:PublishAot=true -o ./publish/ccm-win-arm64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-win-arm64-bin
          path: ./publish/ccm-win-arm64
          retention-days: 7

  build-osx-x64:
    runs-on: macos-latest
    timeout-minutes: 45
    needs: build-win-arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: å‘å¸ƒ osx-x64
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r osx-x64 -p:PublishAot=true -o ./publish/ccm-osx-x64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-osx-x64-bin
          path: ./publish/ccm-osx-x64
          retention-days: 7

  build-osx-arm64:
    runs-on: macos-latest
    timeout-minutes: 45
    needs: build-osx-x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: å‘å¸ƒ osx-arm64
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r osx-arm64 -p:PublishAot=true -o ./publish/ccm-osx-arm64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-osx-arm64-bin
          path: ./publish/ccm-osx-arm64
          retention-days: 7

  # ==================== ç¬¬äºŒæ­¥ï¼šå‘å¸ƒåˆ° GitHub ====================
  release-github:
    needs: [build-linux-x64, build-linux-arm64, build-win-x86, build-win-x64, build-win-arm64, build-osx-x64, build-osx-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: æ˜¾ç¤ºæ–‡ä»¶ç»“æ„
        run: |
          echo "=== æ–‡ä»¶ç»“æ„ ==="
          ls -R ./artifacts

      - name: å‹ç¼© Windows å¹³å°æ–‡ä»¶
        run: |
          mkdir -p ./release
          for dir in ./artifacts/ccm-win*-bin/*; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              cd "$dir"
              zip -r "../../../release/${dirname}.zip" .
              cd -
            fi
          done

      - name: å‹ç¼© Unix å¹³å°æ–‡ä»¶
        run: |
          for dir in ./artifacts/ccm-*-bin; do
            if [ -d "$dir" ] && [[ ! "$dir" =~ win ]]; then
              dirname=$(basename "$dir")
              outputname="${dirname%-bin}"
              tar -czf "./release/${outputname}.tar.gz" -C "$dir" .
            fi
          done

      - name: æ˜¾ç¤ºå‘å¸ƒæ–‡ä»¶
        run: ls -lh ./release/

      - name: å‘å¸ƒåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          generate_release_notes: true
          draft: false
          prerelease: false
          name: ${{ github.ref_name }}

  # ==================== ç¬¬ä¸‰æ­¥ï¼šå‘å¸ƒåˆ° Gitee ====================
  release-gitee:
    needs: [build-linux-x64, build-linux-arm64, build-win-x86, build-win-x64, build-win-arm64, build-osx-x64, build-osx-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: å‹ç¼©æ‰€æœ‰å¹³å°æ–‡ä»¶
        run: |
          mkdir -p ./release

          # Windows å¹³å°
          for dir in ./artifacts/ccm-win*-bin/*; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              cd "$dir"
              zip -r "../../../release/${dirname}.zip" .
              cd -
            fi
          done

          # Unix å¹³å°
          for dir in ./artifacts/ccm-*-bin; do
            if [ -d "$dir" ] && [[ ! "$dir" =~ win ]]; then
              dirname=$(basename "$dir")
              outputname="${dirname%-bin}"
              tar -czf "./release/${outputname}.tar.gz" -C "$dir" .
            fi
          done

      - name: æ˜¾ç¤ºå‘å¸ƒæ–‡ä»¶
        run: ls -lh ./release/

      - name: å‘å¸ƒåˆ° Gitee Releases
        uses: nICEnnnnnnnLee/action-gitee-release@master
        with:
          gitee_action: create_release
          gitee_owner: ${{ secrets.GITEE_OWNER }}
          gitee_repo: ${{ secrets.GITEE_REPO }}
          gitee_token: ${{ secrets.GITEE_TOKEN }}
          gitee_tag_name: ${{ github.ref_name }}
          gitee_release_name: ${{ github.ref_name }}
          gitee_release_body: |
            ğŸš€ è‡ªåŠ¨åŒ–å‘å¸ƒ ${{ github.ref_name }}

            æ„å»ºæ—¶é—´ï¼š$(date -u +'%Y-%m-%d %H:%M:%S UTC')
            æäº¤ï¼š${{ github.sha }}
          gitee_target_commitish: ${{ github.ref }}
          gitee_upload_retry_times: 3
          gitee_files: |
            ./release/*
