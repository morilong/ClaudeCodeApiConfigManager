name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PROJECT_NAME: ClaudeCodeApiConfigManager
  CONFIGURATION: Release

jobs:
  # ==================== Á¨¨‰∏ÄÊ≠•ÔºöÊûÑÂª∫ ====================
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            runtime: linux-x64
            output: ccm-linux-x64
          - os: ubuntu-latest
            runtime: linux-arm64
            output: ccm-linux-arm64

          # Windows
          - os: windows-latest
            runtime: win-x86
            output: ccm-win-x86
          - os: windows-latest
            runtime: win-x64
            output: ccm-win-x64
          - os: windows-latest
            runtime: win-arm64
            output: ccm-win-arm64

          # macOS
          - os: macos-latest
            runtime: osx-x64
            output: ccm-osx-x64
          - os: macos-latest
            runtime: osx-arm64
            output: ccm-osx-arm64

    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ÂÆâË£Ö .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: ÂèëÂ∏ÉÂèØÊâßË°åÊñá‰ª∂
        run: |
          dotnet publish ./${{ env.PROJECT_NAME }}.csproj \
            -c ${{ env.CONFIGURATION }} \
            -r ${{ matrix.runtime }} \
            --self-contained true \
            -p:PublishAot=true \
            -p:PublishTrimmed=true \
            -o ./publish/${{ matrix.output }}

      - name: ‰∏ä‰º†ÊûÑÂª∫‰∫ßÁâ©ÔºàÂéüÂßãÂèØÊâßË°åÊñá‰ª∂Ôºâ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output }}-bin
          path: ./publish/${{ matrix.output }}
          retention-days: 7

  # ==================== Á¨¨‰∫åÊ≠•ÔºöÂèëÂ∏ÉÂà∞ GitHub ====================
  release-github:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ‰∏ãËΩΩÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ÊòæÁ§∫Êñá‰ª∂ÁªìÊûÑ
        run: |
          echo "=== Êñá‰ª∂ÁªìÊûÑ ==="
          ls -R ./artifacts

      - name: ÂéãÁº© Windows Âπ≥Âè∞Êñá‰ª∂
        run: |
          mkdir -p ./release
          for dir in ./artifacts/ccm-win*-bin/*; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              outputname="${dirname%-bin}"
              cd "$dir"
              zip -r "../../../release/${outputname}.zip" .
              cd -
            fi
          done

      - name: ÂéãÁº© Unix Âπ≥Âè∞Êñá‰ª∂
        run: |
          for dir in ./artifacts/ccm-*-bin; do
            if [ -d "$dir" ] && [[ ! "$dir" =~ win ]]; then
              dirname=$(basename "$dir")
              outputname="${dirname%-bin}"
              tar -czf "./release/${outputname}.tar.gz" -C "$dir" .
            fi
          done

      - name: ÊòæÁ§∫ÂèëÂ∏ÉÊñá‰ª∂
        run: ls -lh ./release/

      - name: ÂèëÂ∏ÉÂà∞ GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          generate_release_notes: true
          draft: false
          prerelease: false
          name: ${{ github.ref_name }}

  # ==================== Á¨¨‰∏âÊ≠•ÔºöÂèëÂ∏ÉÂà∞ Gitee ====================
  release-gitee:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ‰∏ãËΩΩÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ÂéãÁº©ÊâÄÊúâÂπ≥Âè∞Êñá‰ª∂
        run: |
          mkdir -p ./release

          # Windows Âπ≥Âè∞
          for dir in ./artifacts/ccm-win*-bin/*; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              outputname="${dirname%-bin}"
              cd "$dir"
              zip -r "../../../release/${outputname}.zip" .
              cd -
            fi
          done

          # Unix Âπ≥Âè∞
          for dir in ./artifacts/ccm-*-bin; do
            if [ -d "$dir" ] && [[ ! "$dir" =~ win ]]; then
              dirname=$(basename "$dir")
              outputname="${dirname%-bin}"
              tar -czf "./release/${outputname}.tar.gz" -C "$dir" .
            fi
          done

      - name: ÂàõÂª∫ Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: ${{ secrets.GITEE_OWNER }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          VERSION="${GITHUB_REF_NAME}"

          # Ê£ÄÊü• Release ÊòØÂê¶Â∑≤Â≠òÂú®Ôºå‰∏çÂ≠òÂú®ÂàôÂàõÂª∫
          if ! curl -s -f "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/tags/${VERSION}" > /dev/null; then
            echo "ÂàõÂª∫ Gitee Release: ${VERSION}"
            curl -X POST \
              "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "tag_name=${VERSION}" \
              -d "name=${VERSION}" \
              -d "body=üöÄ Ëá™Âä®ÂåñÂèëÂ∏É ${VERSION}%0A%0AÊûÑÂª∫Êó∂Èó¥Ôºö$(date -u +'%Y-%m-%d %H:%M:%S UTC')%0AÊèê‰∫§Ôºö${{ github.sha }}" \
              -d "target_commitish=${{ github.ref }}"
          else
            echo "Release ${VERSION} Â∑≤Â≠òÂú®"
          fi

      - name: ‰∏ä‰º†Êñá‰ª∂Âà∞ Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: ${{ secrets.GITEE_OWNER }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          VERSION="${GITHUB_REF_NAME}"

          for file in ./release/*; do
            filename=$(basename "$file")
            echo "‰∏ä‰º†: $filename"

            curl -X POST \
              "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${VERSION}/assets" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -F "file=@${file}"
          done
