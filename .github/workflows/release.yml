name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PROJECT_NAME: ClaudeCodeApiConfigManager
  CONFIGURATION: Release

jobs:
  # ==================== Á¨¨‰∏ÄÊ≠•ÔºöÊûÑÂª∫Ôºà‰∏≤Ë°åÔºâ====================
  build-linux-x64:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: ÂèëÂ∏É linux-x64
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r linux-x64 -p:PublishAot=true -o ./publish/ccm-linux-x64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-linux-x64-bin
          path: ./publish/ccm-linux-x64
          retention-days: 7

  build-linux-arm64:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: build-linux-x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: ÂèëÂ∏É linux-arm64
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r linux-arm64 -p:PublishAot=true -o ./publish/ccm-linux-arm64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-linux-arm64-bin
          path: ./publish/ccm-linux-arm64
          retention-days: 7

  build-win-x86:
    runs-on: windows-latest
    timeout-minutes: 45
    needs: build-linux-arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: ÂèëÂ∏É win-x86
        shell: pwsh
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r win-x86 -p:PublishAot=true -o ./publish/ccm-win-x86
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-win-x86-bin
          path: ./publish/ccm-win-x86
          retention-days: 7

  build-win-x64:
    runs-on: windows-latest
    timeout-minutes: 45
    needs: build-win-x86
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: ÂèëÂ∏É win-x64
        shell: pwsh
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r win-x64 -p:PublishAot=true -o ./publish/ccm-win-x64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-win-x64-bin
          path: ./publish/ccm-win-x64
          retention-days: 7

  build-win-arm64:
    runs-on: windows-latest
    timeout-minutes: 45
    needs: build-win-x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: ÂèëÂ∏É win-arm64
        shell: pwsh
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r win-arm64 -p:PublishAot=true -o ./publish/ccm-win-arm64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-win-arm64-bin
          path: ./publish/ccm-win-arm64
          retention-days: 7

  build-osx-x64:
    runs-on: macos-latest
    timeout-minutes: 45
    needs: build-win-arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: ÂèëÂ∏É osx-x64
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r osx-x64 -p:PublishAot=true -o ./publish/ccm-osx-x64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-osx-x64-bin
          path: ./publish/ccm-osx-x64
          retention-days: 7

  build-osx-arm64:
    runs-on: macos-latest
    timeout-minutes: 45
    needs: build-osx-x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: ÂèëÂ∏É osx-arm64
        run: dotnet publish ./${{ env.PROJECT_NAME }}.csproj -c ${{ env.CONFIGURATION }} -r osx-arm64 -p:PublishAot=true -o ./publish/ccm-osx-arm64
      - uses: actions/upload-artifact@v4
        with:
          name: ccm-osx-arm64-bin
          path: ./publish/ccm-osx-arm64
          retention-days: 7

  # ==================== Á¨¨‰∫åÊ≠•ÔºöÂèëÂ∏ÉÂà∞ GitHub ====================
  release-github:
    needs: [build-linux-x64, build-linux-arm64, build-win-x86, build-win-x64, build-win-arm64, build-osx-x64, build-osx-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ‰∏ãËΩΩÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ÊòæÁ§∫Êñá‰ª∂ÁªìÊûÑ
        run: |
          echo "=== Êñá‰ª∂ÁªìÊûÑ ==="
          ls -R ./artifacts

      - name: ÂéãÁº© Windows Âπ≥Âè∞Êñá‰ª∂
        run: |
          mkdir -p ./release
          for dir in ./artifacts/ccm-win*-bin/*; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              cd "$dir"
              zip -r "../../../release/${dirname}.zip" .
              cd -
            fi
          done

      - name: ÂéãÁº© Unix Âπ≥Âè∞Êñá‰ª∂
        run: |
          for dir in ./artifacts/ccm-*-bin; do
            if [ -d "$dir" ] && [[ ! "$dir" =~ win ]]; then
              dirname=$(basename "$dir")
              outputname="${dirname%-bin}"
              tar -czf "./release/${outputname}.tar.gz" -C "$dir" .
            fi
          done

      - name: ÊòæÁ§∫ÂèëÂ∏ÉÊñá‰ª∂
        run: ls -lh ./release/

      - name: ÂèëÂ∏ÉÂà∞ GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          generate_release_notes: true
          draft: false
          prerelease: false
          name: ${{ github.ref_name }}

  # ==================== Á¨¨‰∏âÊ≠•ÔºöÂèëÂ∏ÉÂà∞ Gitee ====================
  release-gitee:
    needs: [build-linux-x64, build-linux-arm64, build-win-x86, build-win-x64, build-win-arm64, build-osx-x64, build-osx-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: ‰∏ãËΩΩÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ÂéãÁº©ÊâÄÊúâÂπ≥Âè∞Êñá‰ª∂
        run: |
          mkdir -p ./release

          # Windows Âπ≥Âè∞
          for dir in ./artifacts/ccm-win*-bin/*; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              cd "$dir"
              zip -r "../../../release/${dirname}.zip" .
              cd -
            fi
          done

          # Unix Âπ≥Âè∞
          for dir in ./artifacts/ccm-*-bin; do
            if [ -d "$dir" ] && [[ ! "$dir" =~ win ]]; then
              dirname=$(basename "$dir")
              outputname="${dirname%-bin}"
              tar -czf "./release/${outputname}.tar.gz" -C "$dir" .
            fi
          done

      - name: ÂàõÂª∫ Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: ${{ secrets.GITEE_OWNER }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          VERSION="${GITHUB_REF_NAME}"

          # Ê£ÄÊü• Release ÊòØÂê¶Â∑≤Â≠òÂú®Ôºå‰∏çÂ≠òÂú®ÂàôÂàõÂª∫
          if ! curl -s -f "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/tags/${VERSION}" > /dev/null; then
            echo "ÂàõÂª∫ Gitee Release: ${VERSION}"
            curl -X POST \
              "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "tag_name=${VERSION}" \
              -d "name=${VERSION}" \
              -d "body=üöÄ Ëá™Âä®ÂåñÂèëÂ∏É ${VERSION}%0A%0AÊûÑÂª∫Êó∂Èó¥Ôºö$(date -u +'%Y-%m-%d %H:%M:%S UTC')%0AÊèê‰∫§Ôºö${{ github.sha }}" \
              -d "target_commitish=${{ github.ref }}"
          else
            echo "Release ${VERSION} Â∑≤Â≠òÂú®"
          fi

      - name: ‰∏ä‰º†Êñá‰ª∂Âà∞ Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: ${{ secrets.GITEE_OWNER }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          VERSION="${GITHUB_REF_NAME}"

          for file in ./release/*; do
            filename=$(basename "$file")
            echo "‰∏ä‰º†: $filename"

            curl -X POST \
              "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${VERSION}/assets" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -F "file=@${file}"
          done
